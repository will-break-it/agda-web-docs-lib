name: 'Test GitHub Action'

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-action:
    name: 'Test Agda Docs Action'
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ§ª Create test HTML files
        run: |
          mkdir -p test-html/
          cat > test-html/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head><title>Test Agda Module</title></head>
          <body>
            <h1>Test Module</h1>
            <pre class="Agda">
            <span class="Symbol">{-#</span> <span class="Keyword">OPTIONS</span> <span class="Pragma">--safe</span> <span class="Symbol">#-}</span>
            <span class="Keyword">module</span> <span class="Module">Test</span> <span class="Keyword">where</span>

            <span class="Keyword">data</span> <span class="Datatype">â„•</span> <span class="Symbol">:</span> <span class="PrimitiveType">Set</span> <span class="Keyword">where</span>
              <span class="InductiveConstructor">zero</span> <span class="Symbol">:</span> <span class="Datatype">â„•</span>
              <span class="InductiveConstructor">suc</span>  <span class="Symbol">:</span> <span class="Datatype">â„•</span> <span class="Symbol">â†’</span> <span class="Datatype">â„•</span>
            </pre>
          </body>
          </html>
          EOF

          # Create additional test file for module structure
          cat > test-html/Test.Base.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head><title>Test.Base Module</title></head>
          <body>
            <h1>Test.Base Module</h1>
            <pre class="Agda">
            <span class="Keyword">module</span> <span class="Module">Test.Base</span> <span class="Keyword">where</span>
            
            <span class="Keyword">data</span> <span class="Datatype">Bool</span> <span class="Symbol">:</span> <span class="PrimitiveType">Set</span> <span class="Keyword">where</span>
              <span class="InductiveConstructor">true</span> <span class="InductiveConstructor">false</span> <span class="Symbol">:</span> <span class="Datatype">Bool</span>
            </pre>
          </body>
          </html>
          EOF

      - name: ðŸ§ª Create test config
        run: |
          cat > test-agda-docs.config.json << 'EOF'
          {
            "backButtonUrl": "/",
            "inputDir": "test-html/",
            "modules": ["Test"],
            "githubUrl": "https://github.com/will-break-it/agda-web-docs-lib"
          }
          EOF

      - name: ðŸ”„ Test the action
        id: test
        uses: ./
        with:
          input-dir: 'test-html/'
          config-file: 'test-agda-docs.config.json'
          github-url: 'https://github.com/will-break-it/agda-web-docs-lib'
          modules: 'Test'

      - name: âœ… Validate CSS integration
        run: |
          echo "ðŸŽ¨ Testing CSS integration..."
          
          # Fail fast if the action didn't run successfully
          if [ "${{ steps.test.outcome }}" != "success" ]; then
            echo "âŒ Main action failed, skipping validation"
            exit 1
          fi
          
          # Check that CSS files are properly linked
          if ! grep -q 'href="base.css"' test-html/index.html; then
            echo "âŒ base.css not linked"
            exit 1
          fi
          
          if ! grep -q 'href="search.css"' test-html/index.html; then
            echo "âŒ search.css not linked"
            exit 1
          fi
          
          if ! grep -q 'href="typePreview.css"' test-html/index.html; then
            echo "âŒ typePreview.css not linked"
            exit 1
          fi
          
          # Check that CSS files actually exist
          if [ ! -f "test-html/base.css" ]; then
            echo "âŒ base.css file not found"
            exit 1
          fi
          
          if [ ! -f "test-html/search.css" ]; then
            echo "âŒ search.css file not found"
            exit 1
          fi
          
          if [ ! -f "test-html/typePreview.css" ]; then
            echo "âŒ typePreview.css file not found"
            exit 1
          fi
          
          # Verify CSS content contains expected rules
          if ! grep -q ":root {" test-html/base.css; then
            echo "âŒ CSS variables not found in base.css"
            exit 1
          fi
          
          if ! grep -q ".main-wrapper" test-html/base.css; then
            echo "âŒ Main wrapper styles not found"
            exit 1
          fi
          
          if ! grep -q ".sidebar" test-html/base.css; then
            echo "âŒ Sidebar styles not found"
            exit 1
          fi
          
          if ! grep -q ".theme-toggle" test-html/base.css; then
            echo "âŒ Theme toggle styles not found"
            exit 1
          fi
          
          echo "âœ… CSS integration verified"

      - name: âœ… Validate JavaScript integration
        run: |
          echo "âš¡ Testing JavaScript integration..."
          
          # Fail fast if the action didn't run successfully
          if [ "${{ steps.test.outcome }}" != "success" ]; then
            echo "âŒ Main action failed, skipping validation"
            exit 1
          fi
          
          # Check that all required JS files are linked
          if ! grep -q 'src="themeInit.js"' test-html/index.html; then
            echo "âŒ themeInit.js not linked"
            exit 1
          fi
          
          if ! grep -q 'src="codeBlocks.js"' test-html/index.html; then
            echo "âŒ codeBlocks.js not linked"
            exit 1
          fi
          
          if ! grep -q 'src="themeToggle.js"' test-html/index.html; then
            echo "âŒ themeToggle.js not linked"
            exit 1
          fi
          
          if ! grep -q 'src="sidebarToggle.js"' test-html/index.html; then
            echo "âŒ sidebarToggle.js not linked"
            exit 1
          fi
          
          if ! grep -q 'src="search.js"' test-html/index.html; then
            echo "âŒ search.js not linked"
            exit 1
          fi
          
          if ! grep -q 'src="typePreview.js"' test-html/index.html; then
            echo "âŒ typePreview.js not linked"
            exit 1
          fi
          
          # Check that JS files actually exist
          for script in themeInit.js codeBlocks.js themeToggle.js sidebarToggle.js search.js typePreview.js; do
            if [ ! -f "test-html/$script" ]; then
              echo "âŒ $script file not found"
              exit 1
            fi
          done
          
          # Verify JS content contains expected functions
          if ! grep -q "copyCode" test-html/codeBlocks.js; then
            echo "âŒ copyCode function not found in codeBlocks.js"
            exit 1
          fi
          
          if ! grep -q "toggleSidebar" test-html/sidebarToggle.js; then
            echo "âŒ toggleSidebar function not found"
            exit 1
          fi
          
          echo "âœ… JavaScript integration verified"

      - name: âœ… Validate DOM structure
        run: |
          echo "ðŸ—ï¸ Testing DOM structure..."
          
          # Fail fast if the action didn't run successfully
          if [ "${{ steps.test.outcome }}" != "success" ]; then
            echo "âŒ Main action failed, skipping validation"
            exit 1
          fi
          
          # Check for header structure
          if ! grep -q '<header>' test-html/index.html; then
            echo "âŒ Header element not found"
            exit 1
          fi
          
          if ! grep -q 'class="header-left"' test-html/index.html; then
            echo "âŒ Header left section not found"
            exit 1
          fi
          
          if ! grep -q 'class="header-right"' test-html/index.html; then
            echo "âŒ Header right section not found"
            exit 1
          fi
          
          # Check for main layout structure
          if ! grep -q 'class="main-wrapper"' test-html/index.html; then
            echo "âŒ Main wrapper not found"
            exit 1
          fi
          
          if ! grep -q 'class="sidebar"' test-html/index.html; then
            echo "âŒ Sidebar not found"
            exit 1
          fi
          
          if ! grep -q 'class="main-content"' test-html/index.html; then
            echo "âŒ Main content wrapper not found"
            exit 1
          fi
          
          # Check for sidebar content
          if ! grep -q 'class="modules-header"' test-html/index.html; then
            echo "âŒ Modules header not found"
            exit 1
          fi
          
          if ! grep -q 'class="module-list"' test-html/index.html; then
            echo "âŒ Module list not found"
            exit 1
          fi
          
          if ! grep -q 'class="module-link"' test-html/index.html; then
            echo "âŒ Module links not found"
            exit 1
          fi
          
          # Check for theme toggle button
          if ! grep -q 'class="theme-toggle"' test-html/index.html; then
            echo "âŒ Theme toggle button not found"
            exit 1
          fi
          
          # Check for back button (since we configured one)
          if ! grep -q 'class="back-button"' test-html/index.html; then
            echo "âŒ Back button not found"
            exit 1
          fi
          
          # Check for GitHub link (since we configured one)
          if ! grep -q 'class="github-link"' test-html/index.html; then
            echo "âŒ GitHub link not found"
            exit 1
          fi
          
          # Check for mobile menu toggle
          if ! grep -q 'class="menu-toggle"' test-html/index.html; then
            echo "âŒ Menu toggle button not found"
            exit 1
          fi
          
          echo "âœ… DOM structure verified"

      - name: âœ… Validate code block enhancement
        run: |
          echo "ðŸ“ Testing code block enhancements..."
          
          # Fail fast if the action didn't run successfully
          if [ "${{ steps.test.outcome }}" != "success" ]; then
            echo "âŒ Main action failed, skipping validation"
            exit 1
          fi
          
          # Check for code container structure
          if ! grep -q 'class="code-container"' test-html/index.html; then
            echo "âŒ Code container not found"
            exit 1
          fi
          
          if ! grep -q 'class="line-numbers"' test-html/index.html; then
            echo "âŒ Line numbers not found"
            exit 1
          fi
          
          if ! grep -q 'class="code-content"' test-html/index.html; then
            echo "âŒ Code content wrapper not found"
            exit 1
          fi
          
          if ! grep -q 'class="code-line"' test-html/index.html; then
            echo "âŒ Code lines not found"
            exit 1
          fi
          
          if ! grep -q 'class="line-number"' test-html/index.html; then
            echo "âŒ Line number elements not found"
            exit 1
          fi
          
          # Check for copy button
          if ! grep -q 'class="copy-code-button"' test-html/index.html; then
            echo "âŒ Copy code button not found"
            exit 1
          fi
          
          # Check for has-copy-button class on pre
          if ! grep -q 'class="Agda has-copy-button"' test-html/index.html; then
            echo "âŒ has-copy-button class not added to pre element"
            exit 1
          fi
          
          # Check that line numbers have proper data attributes
          if ! grep -q 'data-line-number=' test-html/index.html; then
            echo "âŒ Line number data attributes not found"
            exit 1
          fi
          
          if ! grep -q 'data-block-id=' test-html/index.html; then
            echo "âŒ Block ID data attributes not found"
            exit 1
          fi
          
          echo "âœ… Code block enhancements verified"

      - name: âœ… Validate responsive meta tags
        run: |
          echo "ðŸ“± Testing responsive design elements..."
          
          # Fail fast if the action didn't run successfully
          if [ "${{ steps.test.outcome }}" != "success" ]; then
            echo "âŒ Main action failed, skipping validation"
            exit 1
          fi
          
          # Check for viewport meta tag
          if ! grep -q 'name="viewport"' test-html/index.html; then
            echo "âŒ Viewport meta tag not found"
            exit 1
          fi
          
          if ! grep -q 'charset=' test-html/index.html; then
            echo "âŒ Charset meta tag not found"
            exit 1
          fi
          
          echo "âœ… Responsive design elements verified"

      - name: âœ… Validate accessibility features
        run: |
          echo "â™¿ Testing accessibility features..."
          
          # Fail fast if the action didn't run successfully
          if [ "${{ steps.test.outcome }}" != "success" ]; then
            echo "âŒ Main action failed, skipping validation"
            exit 1
          fi
          
          # Check for aria-label attributes
          if ! grep -q 'aria-label=' test-html/index.html; then
            echo "âŒ ARIA labels not found"
            exit 1
          fi
          
          # Check for title attributes on buttons
          if ! grep -q 'title=' test-html/index.html; then
            echo "âŒ Title attributes not found"
            exit 1
          fi
          
          echo "âœ… Accessibility features verified"

      - name: âœ… Validate search functionality setup
        run: |
          echo "ðŸ” Testing search functionality setup..."
          
          # Fail fast if the action didn't run successfully
          if [ "${{ steps.test.outcome }}" != "success" ]; then
            echo "âŒ Main action failed, skipping validation"
            exit 1
          fi
          
          # Check for type preview container
          if ! grep -q 'id="type-preview-container"' test-html/index.html; then
            echo "âŒ Type preview container not found"
            exit 1
          fi
          
          echo "âœ… Search functionality setup verified"

      - name: âœ… Validate module structure
        run: |
          echo "ðŸ“‚ Testing module structure..."
          
          # Fail fast if the action didn't run successfully
          if [ "${{ steps.test.outcome }}" != "success" ]; then
            echo "âŒ Main action failed, skipping validation"
            exit 1
          fi
          
          # Both test files should have been processed
          if [ ! -f "test-html/Test.Base.html" ]; then
            echo "âŒ Test.Base.html not found"
            exit 1
          fi
          
          # Check that both files contain the enhanced structure
          for file in index.html Test.Base.html; do
            if ! grep -q 'class="sidebar"' "test-html/$file"; then
              echo "âŒ Sidebar not found in $file"
              exit 1
            fi
            
            if ! grep -q 'class="main-wrapper"' "test-html/$file"; then
              echo "âŒ Main wrapper not found in $file"
              exit 1
            fi
          done
          
          # Check that the sidebar contains both modules
          if ! grep -q 'Test' test-html/index.html; then
            echo "âŒ Test module not found in sidebar"
            exit 1
          fi
          
          echo "âœ… Module structure verified"

      - name: âœ… Final validation
        run: |
          # Fail fast if the action didn't run successfully
          if [ "${{ steps.test.outcome }}" != "success" ]; then
            echo "âŒ Main action failed, cannot perform final validation"
            exit 1
          fi
          
          echo "Files processed: ${{ steps.test.outputs.files-processed }}"
          echo "Output directory: ${{ steps.test.outputs.output-directory }}"
          
          # Verify that files were processed
          if [ "${{ steps.test.outputs.files-processed }}" -eq "0" ]; then
            echo "âŒ No files were processed"
            exit 1
          fi
          
          # Expected to process 2 HTML files
          if [ "${{ steps.test.outputs.files-processed }}" -ne "2" ]; then
            echo "âŒ Expected 2 files to be processed, got ${{ steps.test.outputs.files-processed }}"
            exit 1
          fi
          
          echo "ðŸŽ‰ All comprehensive tests passed!"
          echo ""
          echo "âœ… CSS styles properly integrated"
          echo "âœ… JavaScript functionality properly integrated" 
          echo "âœ… DOM structure correctly transformed"
          echo "âœ… Code blocks enhanced with line numbers and copy functionality"
          echo "âœ… Responsive design elements added"
          echo "âœ… Accessibility features implemented"
          echo "âœ… Search and type preview functionality set up"
          echo "âœ… Module structure properly created"

      - name: ðŸ“¤ Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-html/
          retention-days: 1

      - name: ðŸ“‹ Display file samples for debugging
        if: always()
        run: |
          echo "=== INDEX.HTML SAMPLE ==="
          head -50 test-html/index.html
          echo ""
          echo "=== LINKED CSS FILES ==="
          ls -la test-html/*.css 2>/dev/null || echo "No CSS files found"
          echo ""
          echo "=== LINKED JS FILES ==="
          ls -la test-html/*.js 2>/dev/null || echo "No JS files found" 